name: Run tests
on:
  push:
  workflow_dispatch:
    inputs:
      buildkit-tag:
        description: "The isle-buildkit tag to pull for the fleet of docker containers"
        required: true
        type: string
        default: "main"
      starter-site-owner:
        description: "The GitHub org the starter site resides in"
        required: true
        type: string
        default: "Islandora-Devops"
      starter-site-ref:
        description: "The islandora-starter-site git ref to checkout (heads/BRANCH-NAME or tags/TAG-NAME)"
        required: true
        type: string
        default: "heads/main"
  schedule:
    - cron: "15 11 * * *"
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, windows-2022, windows-2025]
    env:
      TERM: xterm-256color
    defaults:
      run:
        shell: ${{ startsWith(matrix.os, 'windows') && 'wsl-bash {0}' || 'bash' }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup ISLE
        uses: ./.github/actions/setup
        with:
          buildkit-tag: "${{ github.event.inputs.buildkit-tag || 'main' }}"
          starter-site-owner: "${{ github.event.inputs.starter-site-owner || 'islandora-devops' }}"
          starter-site-ref: "${{ github.event.inputs.starter-site-ref || 'heads/main' }}"

      - name: Test switching frontend to TLS
        run: make traefik-https-mkcert down-traefik up ping

      - name: Switch back to HTTP
        run: make traefik-http down-traefik up ping

      - name: Collect logs for each service
        if: ${{ failure() }}
        run: |
          mkdir -p logs
          services=$(docker compose config --services 2>/dev/null)
          for service in $services; do
            docker compose logs $service --tail 100 2>/dev/null > "logs/${service}.log"
          done
          docker compose exec mariadb mysqldump drupal_default 2>/dev/null > logs/drupal_default.sql

      - name: Upload logs as artifacts
        if: ${{ failure() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: docker-logs-${{ matrix.os }}
          path: logs/*

      - name: Notify Slack on nightly test failure
        if: failure() && github.event_name == 'schedule'
        run: |-
          curl -s -o /dev/null -XPOST $SLACK_WEBHOOK_URL -d '{
            "text": "ðŸš¨ Scheduled job failed! Click to view the run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          }'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: cleanup
        if: ${{ always() }}
        run: make down
